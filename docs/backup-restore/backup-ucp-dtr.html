<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Backup UCP and DTR | HPE Express Containers with Docker Enterprise Edition on HPE SimpliVity</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/assets/css/styles.1d742706.css" as="style"><link rel="preload" href="/assets/js/app.1d742706.js" as="script"><link rel="preload" href="/assets/js/24.7648202d.js" as="script"><link rel="prefetch" href="/assets/css/19.styles.1dbeaabf.css"><link rel="prefetch" href="/assets/css/5.styles.0834f364.css"><link rel="prefetch" href="/assets/js/1.35a7667f.js"><link rel="prefetch" href="/assets/js/10.4ed1ab48.js"><link rel="prefetch" href="/assets/js/100.0f330ffb.js"><link rel="prefetch" href="/assets/js/101.c84a6b9f.js"><link rel="prefetch" href="/assets/js/102.2ddad81d.js"><link rel="prefetch" href="/assets/js/103.3eb293c6.js"><link rel="prefetch" href="/assets/js/11.53f6866d.js"><link rel="prefetch" href="/assets/js/12.165d386d.js"><link rel="prefetch" href="/assets/js/13.321bdfcd.js"><link rel="prefetch" href="/assets/js/14.e10cafb0.js"><link rel="prefetch" href="/assets/js/15.5d48576f.js"><link rel="prefetch" href="/assets/js/16.2d1ca4a0.js"><link rel="prefetch" href="/assets/js/17.7f7a759c.js"><link rel="prefetch" href="/assets/js/18.685249dd.js"><link rel="prefetch" href="/assets/js/19.1dbeaabf.js"><link rel="prefetch" href="/assets/js/2.fa678002.js"><link rel="prefetch" href="/assets/js/20.152f22e2.js"><link rel="prefetch" href="/assets/js/21.a31540cc.js"><link rel="prefetch" href="/assets/js/22.ff055cc2.js"><link rel="prefetch" href="/assets/js/23.734ffd65.js"><link rel="prefetch" href="/assets/js/25.db89104e.js"><link rel="prefetch" href="/assets/js/26.efdfeba1.js"><link rel="prefetch" href="/assets/js/27.5a5a57ff.js"><link rel="prefetch" href="/assets/js/28.0ae50273.js"><link rel="prefetch" href="/assets/js/29.2698371d.js"><link rel="prefetch" href="/assets/js/3.a7e3eb5f.js"><link rel="prefetch" href="/assets/js/30.dc729a90.js"><link rel="prefetch" href="/assets/js/31.74a00003.js"><link rel="prefetch" href="/assets/js/32.edcb5956.js"><link rel="prefetch" href="/assets/js/33.12a2dd0a.js"><link rel="prefetch" href="/assets/js/34.1a1a2c0b.js"><link rel="prefetch" href="/assets/js/35.73de923a.js"><link rel="prefetch" href="/assets/js/36.954d7cc4.js"><link rel="prefetch" href="/assets/js/37.a852a151.js"><link rel="prefetch" href="/assets/js/38.e9150925.js"><link rel="prefetch" href="/assets/js/39.fb4372cf.js"><link rel="prefetch" href="/assets/js/4.040b7be7.js"><link rel="prefetch" href="/assets/js/40.7385d083.js"><link rel="prefetch" href="/assets/js/41.2d493285.js"><link rel="prefetch" href="/assets/js/42.9969f5d8.js"><link rel="prefetch" href="/assets/js/43.4a6153ff.js"><link rel="prefetch" href="/assets/js/44.13fdcd5e.js"><link rel="prefetch" href="/assets/js/45.14f88bac.js"><link rel="prefetch" href="/assets/js/46.eb9f27e5.js"><link rel="prefetch" href="/assets/js/47.0c9838e0.js"><link rel="prefetch" href="/assets/js/48.fe95686b.js"><link rel="prefetch" href="/assets/js/49.f5437f8d.js"><link rel="prefetch" href="/assets/js/5.0834f364.js"><link rel="prefetch" href="/assets/js/50.502833fb.js"><link rel="prefetch" href="/assets/js/51.adde333e.js"><link rel="prefetch" href="/assets/js/52.1237a790.js"><link rel="prefetch" href="/assets/js/53.ab86a657.js"><link rel="prefetch" href="/assets/js/54.b7a7b314.js"><link rel="prefetch" href="/assets/js/55.3305b05d.js"><link rel="prefetch" href="/assets/js/56.e6027d2e.js"><link rel="prefetch" href="/assets/js/57.1f648e4d.js"><link rel="prefetch" href="/assets/js/58.f6bfd4ff.js"><link rel="prefetch" href="/assets/js/59.eef6ccb9.js"><link rel="prefetch" href="/assets/js/6.e2d397dd.js"><link rel="prefetch" href="/assets/js/60.4ec0d89b.js"><link rel="prefetch" href="/assets/js/61.b3f57eaa.js"><link rel="prefetch" href="/assets/js/62.4316b7df.js"><link rel="prefetch" href="/assets/js/63.25a9fed2.js"><link rel="prefetch" href="/assets/js/64.691e0b90.js"><link rel="prefetch" href="/assets/js/65.c5b7b8f6.js"><link rel="prefetch" href="/assets/js/66.b8016ae6.js"><link rel="prefetch" href="/assets/js/67.f16d507a.js"><link rel="prefetch" href="/assets/js/68.93d66254.js"><link rel="prefetch" href="/assets/js/69.c7a3a47d.js"><link rel="prefetch" href="/assets/js/7.0a1ba327.js"><link rel="prefetch" href="/assets/js/70.7dc2f076.js"><link rel="prefetch" href="/assets/js/71.7ff22b73.js"><link rel="prefetch" href="/assets/js/72.87d2748d.js"><link rel="prefetch" href="/assets/js/73.e3e089b6.js"><link rel="prefetch" href="/assets/js/74.218c9081.js"><link rel="prefetch" href="/assets/js/75.77994fef.js"><link rel="prefetch" href="/assets/js/76.d0c9edb7.js"><link rel="prefetch" href="/assets/js/77.f94e14bf.js"><link rel="prefetch" href="/assets/js/78.23d48985.js"><link rel="prefetch" href="/assets/js/79.259ec231.js"><link rel="prefetch" href="/assets/js/8.8ab7a658.js"><link rel="prefetch" href="/assets/js/80.3c2e5ac1.js"><link rel="prefetch" href="/assets/js/81.4528e255.js"><link rel="prefetch" href="/assets/js/82.e622cf0a.js"><link rel="prefetch" href="/assets/js/83.159855a7.js"><link rel="prefetch" href="/assets/js/84.b249ced0.js"><link rel="prefetch" href="/assets/js/85.31776253.js"><link rel="prefetch" href="/assets/js/86.a68f8a03.js"><link rel="prefetch" href="/assets/js/87.e03784f8.js"><link rel="prefetch" href="/assets/js/88.91a3ba0c.js"><link rel="prefetch" href="/assets/js/89.1a0812a5.js"><link rel="prefetch" href="/assets/js/9.4bba12f2.js"><link rel="prefetch" href="/assets/js/90.4b63064c.js"><link rel="prefetch" href="/assets/js/91.fc31678a.js"><link rel="prefetch" href="/assets/js/92.c09b1cfe.js"><link rel="prefetch" href="/assets/js/93.5be1f871.js"><link rel="prefetch" href="/assets/js/94.82451908.js"><link rel="prefetch" href="/assets/js/95.685ee3dc.js"><link rel="prefetch" href="/assets/js/96.c99acfbf.js"><link rel="prefetch" href="/assets/js/97.1408a20c.js"><link rel="prefetch" href="/assets/js/98.0cc34627.js"><link rel="prefetch" href="/assets/js/99.3e31e06e.js">
    <link rel="stylesheet" href="/assets/css/19.styles.1dbeaabf.css"><link rel="stylesheet" href="/assets/css/5.styles.0834f364.css"><link rel="stylesheet" href="/assets/css/styles.1d742706.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">HPE Express Containers with Docker Enterprise Edition on HPE SimpliVity</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/blog/" class="nav-link">Blog</a></div> <a href="https://github.com/HewlettPackard/Docker-Simplivity" target="_blank" rel="noopener noreferrer" class="repo-link">
    Contribute!
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/blog/" class="nav-link">Blog</a></div> <a href="https://github.com/HewlettPackard/Docker-Simplivity" target="_blank" rel="noopener noreferrer" class="repo-link">
    Contribute!
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading"><span>Introduction</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Release notes</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Solution overview</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Solution components</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Preparing the environment</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Configuring the core components</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Overview of the playbooks</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Deploying core components</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Post deployment</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Configuring Storage</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Deploying Windows workers</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Deploying Sysdig monitoring</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Deploying Splunk</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Deploying Prometheus and Grafana on Kubernetes</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Deploying Prometheus and Grafana on Docker Swarm</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>Backup and restore</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/backup-restore/backup-restore.html" class="sidebar-link">Introduction to backup and restore</a></li><li><a href="/backup-restore/backup-ucp-dtr.html" class="active sidebar-link">Backup UCP and DTR</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/backup-restore/backup-ucp-dtr.html#backup-configuration-variables" class="sidebar-link">Backup configuration variables</a></li><li class="sidebar-sub-header"><a href="/backup-restore/backup-ucp-dtr.html#backing-up-the-swarm" class="sidebar-link">Backing up the Swarm</a></li><li class="sidebar-sub-header"><a href="/backup-restore/backup-ucp-dtr.html#backing-up-the-universal-control-plane-ucp" class="sidebar-link">Backing up the Universal Control Plane (UCP)</a></li><li class="sidebar-sub-header"><a href="/backup-restore/backup-ucp-dtr.html#backing-up-the-docker-trusted-registry-dtr" class="sidebar-link">Backing up the Docker Trusted Registry (DTR)</a></li><li class="sidebar-sub-header"><a href="/backup-restore/backup-ucp-dtr.html#backing-up-dtr-data-images" class="sidebar-link">Backing up DTR data (images)</a></li><li class="sidebar-sub-header"><a href="/backup-restore/backup-ucp-dtr.html#backing-up-other-metadata-including-passwords" class="sidebar-link">Backing up other metadata, including passwords</a></li><li class="sidebar-sub-header"><a href="/backup-restore/backup-ucp-dtr.html#backup-utility" class="sidebar-link">Backup Utility</a></li><li class="sidebar-sub-header"><a href="/backup-restore/backup-ucp-dtr.html#related-playbooks" class="sidebar-link">Related playbooks</a></li></ul></li><li><a href="/backup-restore/restore-ucp-dtr.html" class="sidebar-link">Restoring your cluster after a disaster</a></li><li><a href="/backup-restore/simplivity-backups.html" class="sidebar-link">HPE SimpliVity backups</a></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Solution lifecycle management</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Appendices</span> <span class="arrow right"></span></p> <!----></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="backup-ucp-and-dtr"><a href="#backup-ucp-and-dtr" aria-hidden="true" class="header-anchor">#</a> Backup UCP and DTR</h1> <p>The playbooks support backing up the swarm, UCP, DTR metadata and DTR images.</p> <h2 id="backup-configuration-variables"><a href="#backup-configuration-variables" aria-hidden="true" class="header-anchor">#</a> Backup configuration variables</h2> <p>The following table shows the variables related to backing up UCP and DTR. All these variables are defined in the file <strong>group_vars/backups</strong>. All the data that is backed up is streamed over an SSH connection to the backup server. Currently, the playbooks only support the use of the Ansible box as the backup server.</p> <table><thead><tr><th style="text-align:left">Variable</th> <th style="text-align:left">File</th> <th style="text-align:left">Description</th></tr></thead> <tbody><tr><td style="text-align:left">backup_server</td> <td style="text-align:left"><strong>group_vars/backups</strong></td> <td style="text-align:left">Currently, the playbooks only support the use of the Ansible box as the backup server.</td></tr> <tr><td style="text-align:left">backup_dest</td> <td style="text-align:left"><strong>group_vars/backups</strong></td> <td style="text-align:left">This variable should point to an existing folder on your Ansible box where the <code>root</code> user has write access. All the backups will be stored in this folder. For example, <code>/root/backup</code></td></tr> <tr><td style="text-align:left">#swarm_offline_backups</td> <td style="text-align:left"><strong>group_vars/backup</strong></td> <td style="text-align:left">This variable is commented out by default. More information on this variable is provided below.</td></tr></tbody></table> <h2 id="backing-up-the-swarm"><a href="#backing-up-the-swarm" aria-hidden="true" class="header-anchor">#</a> Backing up the Swarm</h2> <p>When you backup the swarm, your services and stack definitions are backed up together with the networks definitions. However, Docker volumes or their contents will not be backed up. (If Docker volumes are defined in stacks, they will be re-created when you restore the stacks, but their content will be lost). You can backup the swarm using the playbook named <code>backup_swarm.yml</code> which is located in the <code>playbooks</code> folder on your Ansible server. The playbook is invoked as follows:</p> <div class="language- extra-class"><pre class="language-text"><code># ansible-playbook -i vm_hosts playbooks/backup_swarm.yml
</code></pre></div><p>This playbook creates two archives in the folder specified by the variable <code>backup_dest</code> in <code>group_vars/backups</code>. By default, the file is named using the following pattern:</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;backup_dest&gt;/backup_swarm_&lt;vmname&gt;_&lt;timestamp&gt;.tgz
&lt;backup_dest&gt;/backup_swarm_&lt;vmname&gt;_&lt;timestamp&gt;.vars.tgz
</code></pre></div><p><code>&lt;vmname&gt;</code> is the name of the host (in the inventory) that was used to take the backup, and <code>&lt;timestamp&gt;</code> is the time at which the backup was taken. The file with the extension <code>.vars.tgz</code> contains information regarding the system that was backed up.</p> <p>You can override the generated file name by defining the variable <strong>backup_name</strong> on the command line when running the playbook. In the example below:</p> <div class="language- extra-class"><pre class="language-text"><code># ansible-playbook -i vm_hosts playbooks/backup_swarm.yml -e backup_name=**my_swarm_backup**
</code></pre></div><p>The generated files won't have <code>&lt;vmname&gt;</code> or <code>&lt;timestamp&gt;</code> appended:</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;backup_dest&gt;/my_swarm_backup.tgz
&lt;backup_dest&gt;/my_swarm_backup.vars.tgz
</code></pre></div><p><strong>Warning:</strong> <strong>Online versus offline backups:</strong> By default, the playbook performs online backups. You can take offline backups by setting the variable <code>swarm_backup_offline</code> to <code>&quot;true&quot;</code>. The playbook will then stop the Docker daemon on the machine used to take the backup (a manager or UCP node). Before it does so, the playbook will verify that enough managers are running in the cluster to maintain the quorum. If this is not the case, the playbook will exit with an error. For more information, see the Docker documentation at <a href="https://docs.docker.com/engine/swarm/admin_guide/#recover-from-disasterv" target="_blank" rel="noopener noreferrer">https://docs.docker.com/engine/swarm/admin_guide/#recover-from-disasterv<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="backing-up-the-universal-control-plane-ucp"><a href="#backing-up-the-universal-control-plane-ucp" aria-hidden="true" class="header-anchor">#</a> Backing up the Universal Control Plane (UCP)</h2> <p>When you backup UCP, you save the data/metadata outlined in <a href="#backup-ucp-data-meta-table-content">#backup-ucp-data-meta-table-content</a>:</p> <table><thead><tr><th style="text-align:left">Data</th> <th style="text-align:left">Description</th></tr></thead> <tbody><tr><td style="text-align:left">Configurations</td> <td style="text-align:left">The UCP cluster configurations, as shown by <code>docker config ls</code>, including Docker EE license and swarm and client CAs</td></tr> <tr><td style="text-align:left">Access control</td> <td style="text-align:left">Permissions for team access to swarm resources, including collections, grants, and roles</td></tr> <tr><td style="text-align:left">Certificates and keys</td> <td style="text-align:left">The certificates, public keys, and private keys that are used for authentication and mutual TLS communication</td></tr> <tr><td style="text-align:left">Metrics data</td> <td style="text-align:left">Monitoring data gathered by UCP</td></tr> <tr><td style="text-align:left">Organizations</td> <td style="text-align:left">Your users, teams, and orgs</td></tr> <tr><td style="text-align:left">Volumes</td> <td style="text-align:left">All <a href="https://docs.docker.com/datacenter/ucp/2.2/guides/architecture/#volumes-used-by-ucp" target="_blank" rel="noopener noreferrer">UCP named volumes<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, which include all UCP component certs and data</td></tr></tbody></table> <p>To make a backup of UCP, use <code>playbook/backup_ucp.yml</code> as follows:</p> <div class="language- extra-class"><pre class="language-text"><code># ansible-playbook -i vm_host playbooks/backup_ucp.yml
</code></pre></div><p>This playbook creates two archives in the folder specified by the variable <code>backup_dest</code> in <code>group_vars/backups</code>. By default, the files are named using the following pattern:</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;backup_dest&gt;/backup_ucp_&lt;ucpid&gt;_&lt;vmname&gt;_&lt;timestamp&gt;.tgz
&lt;backup_dest&gt;/backup_ucp_&lt;ucpid&gt;_&lt;vmname&gt;_&lt;timestamp&gt;.vars.tgz
</code></pre></div><p><code>&lt;ucpid&gt;</code> is the ID of the UCP instance, <code>&lt;vmname&gt;</code> is the name of the host (in the inventory) that was used to take the backup, and <code>&lt;timestamp&gt;</code> is the time at which the backup was taken. The file with the extension <code>.vars.tgz</code> contains information regarding the system which was backed up.</p> <p>You can override the generated file name by defining the variable <strong>backup_name</strong> on the command line when running the playbook. In the example below:</p> <div class="language- extra-class"><pre class="language-text"><code># ansible-playbook -i vm_hosts playbooks/backup_ucp.yml -e backup_name=**my_ucp_backup**
</code></pre></div><p>The generated files won't have <code>&lt;vmname&gt;</code> or <code>&lt;timestamp&gt;</code> appended:</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;backup_dest&gt;/my_ucp_backup.tgz
&lt;backup_dest&gt;/my_ucp_backup.vars.tgz
</code></pre></div><p><strong>Warning:</strong> To create a consistent backup, the backup command <strong>temporarily stops the UCP containers running on the node where the backup is being performed</strong>. User resources, such as services, containers, and stacks are not affected by this operation and will continue to operate as expected. Any long-lasting <code>docker exec</code>, <code>docker logs</code>, <code>docker events</code>, or <code>docker attach</code> operations on the affected manager node will be disconnected.</p> <p>For more information on UCP backup, see the Docker documentation at <a href="https://docs.docker.com/datacenter/ucp/3.0/guides/admin/backups-and-disaster-recovery/" target="_blank" rel="noopener noreferrer">https://docs.docker.com/datacenter/ucp/3.0/guides/admin/backups-and-disaster-recovery/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="backing-up-the-docker-trusted-registry-dtr"><a href="#backing-up-the-docker-trusted-registry-dtr" aria-hidden="true" class="header-anchor">#</a> Backing up the Docker Trusted Registry (DTR)</h2> <p>When you backup DTR, you save the data/metadata outlined in <a href="#backup-dtr-data-meta-table-content">#backup-dtr-data-meta-table-content</a>:</p> <table><thead><tr><th style="text-align:left">Data</th> <th style="text-align:left">Backed up?</th> <th style="text-align:left">Description</th></tr></thead> <tbody><tr><td style="text-align:left">Configurations</td> <td style="text-align:left">yes</td> <td style="text-align:left">DTR settings</td></tr> <tr><td style="text-align:left">Repository metadata</td> <td style="text-align:left">yes</td> <td style="text-align:left">Metadata like image architecture and size</td></tr> <tr><td style="text-align:left">Access control to repos and images</td> <td style="text-align:left">yes</td> <td style="text-align:left">Data about who has access to which images</td></tr> <tr><td style="text-align:left">Notary data</td> <td style="text-align:left">yes</td> <td style="text-align:left">Signatures and digests for images that are signed</td></tr> <tr><td style="text-align:left">Scan results</td> <td style="text-align:left">yes</td> <td style="text-align:left">Information about vulnerabilities in your images</td></tr> <tr><td style="text-align:left">Certificates and keys</td> <td style="text-align:left">yes</td> <td style="text-align:left">TLS certificates and keys used by DTR</td></tr> <tr><td style="text-align:left">Image content</td> <td style="text-align:left">no</td> <td style="text-align:left">Needs to be backed up separately, depends on DTR configuration</td></tr> <tr><td style="text-align:left">Users, orgs, teams</td> <td style="text-align:left">no</td> <td style="text-align:left">Create a UCP backup to backup this data</td></tr> <tr><td style="text-align:left">Vulnerability database</td> <td style="text-align:left">no</td> <td style="text-align:left">Can be re-downloaded after a restore</td></tr></tbody></table> <p>To make a backup of DTR metadata, use <code>playbook/backup_dtr_metadata.yml</code></p> <div class="language- extra-class"><pre class="language-text"><code># ansible-playbook -i vm_host playbooks/backup_dtr_metadata.yml
</code></pre></div><p>This playbook creates two archives in the folder specified by the variable <code>backup_dest</code> in <code>group_vars/backups</code>. By default, the file is named using the following pattern:</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;backup_dest&gt;/backup_dtr_meta_&lt;replica_id&gt;_&lt;vmname&gt;_&lt;timestamp&gt;.tgz
&lt;backup_dest&gt;/backup_dtr_meta_&lt;replica_id&gt;_&lt;vmname&gt;_&lt;timestamp&gt;.vars.tgz
</code></pre></div><p><code>&lt;replica_id&gt;</code> is the ID of the DTR replica that was backed up, <code>&lt;vmname&gt;</code> is the name of the host (in the inventory) that was used to take the backup, and <code>&lt;timestamp&gt;</code> is the time at which the backup was taken. The file with the extension <code>.vars.tgz</code> contains information regarding the system that was backed up.</p> <p>You can override the generated file name by defining the variable <strong>backup_name</strong> on the command line when running the playbook. In the example below:</p> <div class="language- extra-class"><pre class="language-text"><code># ansible-playbook -i vm_hosts playbooks/backup_dtr_metadata.yml -e backup_name=**my_dtr_metadata_backup**
</code></pre></div><p>The generated files won't have <code>&lt;vmname&gt;</code> or <code>&lt;timestamp&gt;</code> appended:</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;backup_dest&gt;/my_dtr_metadata_backup.tgz
&lt;backup_dest&gt;/my_dtr_metadata_backup.vars.tgz
</code></pre></div><p>For more information on DTR backups, see the Docker documentation at <a href="https://docs.docker.com/datacenter/dtr/2.md" target="_blank" rel="noopener noreferrer">https://docs.docker.com/datacenter/dtr/2.md<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="backing-up-dtr-data-images"><a href="#backing-up-dtr-data-images" aria-hidden="true" class="header-anchor">#</a> Backing up DTR data (images)</h2> <p>To make a backup of the images that are inventoried in DTR and stored on the NFS server, use <code>playbooks/backup_dtr_images.yml</code></p> <div class="language- extra-class"><pre class="language-text"><code># ansible-playbook -i vm_host playbooks/backup_dtr_images.yml
</code></pre></div><p>This playbook creates two archives in the folder specified by the variable <code>backup_dest</code> in <code>group_vars/backups</code>. By default, the files are named using the following pattern:</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;backup_dest&gt;/backup_dtr_data_&lt;replica_id&gt;_&lt;vmname&gt;_&lt;timestamp&gt;.tgz
&lt;backup_dest&gt;/backup_dtr_data_&lt;replica_id&gt;_&lt;vmname&gt;_&lt;timestamp&gt;.vars.tgz
</code></pre></div><p><code>&lt;replica_id&gt;</code> is the ID of the DTR replica that was backed up, <code>&lt;vmname&gt;</code> is the name of the host (in the inventory) that was used to take the backup, and <code>&lt;timestamp&gt;</code> is the time at which the backup was taken.</p> <p>You can override the generated file names by defining the variable <strong>backup_name</strong> on the command line when running the playbook, as shown in the example below:</p> <div class="language- extra-class"><pre class="language-text"><code># ansible-playbook -i vm_hosts playbooks/backup_dtr_images.yml -e backup_name=**my_dtr_data_backup**
</code></pre></div><p>The generated files won't have <code>&lt;vmname&gt;</code> or <code>&lt;timestamp&gt;</code> appended:</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;backup_dest&gt;/my_dtr_data_backup.tgz
&lt;backup_dest&gt;/my_dtr_data_backup.vars.tgz
</code></pre></div><p>For more information on DTR backups, see the Docker documentation at <a href="https://docs.docker.com/datacenter/dtr/2.5/guides/admin/backups-and-disaster-recovery/" target="_blank" rel="noopener noreferrer">https://docs.docker.com/datacenter/dtr/2.5/guides/admin/backups-and-disaster-recovery/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="backing-up-other-metadata-including-passwords"><a href="#backing-up-other-metadata-including-passwords" aria-hidden="true" class="header-anchor">#</a> Backing up other metadata, including passwords</h2> <p>The backup playbooks do not backup the sensitive data in your <code>group_vars/vault</code> file. The information stored in the <code>.vars.tgz</code> files includes backups of the following files:</p> <ul><li><strong>vm_hosts</strong>, a copy of the <code>vm_hosts</code> file at the time the backup was taken</li> <li><strong>vars</strong>, a copy of your <code>group_vars/vars</code> file at the time the backup was taken</li> <li><strong>meta.yml</strong>, a generated file containing information pertaining to the backup</li></ul> <p>The <strong>meta.yml</strong> file contains the following information:</p> <div class="language- extra-class"><pre class="language-text"><code>backup_node=&quot;&lt;node that took the backup&gt;&quot;
replica_id=&quot;&lt;ID of DTR replica if DTR backup&gt;&quot;
backup_source=&quot;&quot;
ucp_version=&quot;&lt;UCP version if UCP backup&gt;&quot;
dtr_version=&quot;&lt;DTR version of DTR backup&gt;&quot;
</code></pre></div><h2 id="backup-utility"><a href="#backup-utility" aria-hidden="true" class="header-anchor">#</a> Backup Utility</h2> <p>The script <code>backup.sh</code> can be used to take a backup of the swarm, UCP, DTR metadata and the DTR images in one go. You can pass this script an argument (tag) that will be used to prefix the backup filenames, thereby overriding the default naming. <a href="#backup-utility-table-content">#backup-utility-table-content</a> shows the file names produced by <code>backup.sh</code> based on the argument passed in the command line.</p> <table><thead><tr><th style="text-align:left">Example</th> <th style="text-align:left">Command line</th> <th style="text-align:left">Generated filenames</th></tr></thead> <tbody><tr><td style="text-align:left">Default</td> <td style="text-align:left"><code>./backup.sh</code></td> <td style="text-align:left">backup_swarm_&lt;vmname&gt;_&lt;timestamp&gt;.tgz, backup_ucp_&lt;ucpid&gt;_&lt;vmname&gt;_&lt;timestamp&gt;.tgz, backup_dtr_meta_&lt;replica_id&gt;_&lt;vmname&gt;_&lt;timestamp&gt;.tgz, backup_dtr_data_&lt;replica_id&gt;_&lt;vmname&gt;_&lt;timestamp&gt;.tgz and the corresponding <code>.vars.tgz</code> files</td></tr> <tr><td style="text-align:left">Custom</td> <td style="text-align:left"><code>./backup.sh my_backup</code></td> <td style="text-align:left">my_backup_swarm.tgz, my_backup_ucp.tgz, my_backup_dtr_meta.tgz, my_backup_dtr_data.tgz, and the corresponding <code>.vars.tgz</code> files</td></tr> <tr><td style="text-align:left">Date</td> <td style="text-align:left"><code>./backup.sh $(date '+%Y_%m_%d_%H%M%S')</code></td> <td style="text-align:left">&lt;date&gt;_swarm.tgz, &lt;date&gt;_ucp.tgz, &lt;date&gt;_dtr_meta.tgz, &lt;date&gt;_dtr_data.tgz, and the corresponding <code>.vars.tgz</code> files</td></tr></tbody></table> <p>In addition, the <code>backup.sh</code> script accepts an optional switch that will let you specify the location of the password file that will be passed to the <code>ansible-playbook</code> commands in the script. This is required if you have encrypted the <code>group_vars/vault</code> file. The general syntax for this script is as follows:</p> <div class="language- extra-class"><pre class="language-text"><code>./backup.sh [ -v &lt;Vault Password File&gt; ] [ tag ]
</code></pre></div><h2 id="related-playbooks"><a href="#related-playbooks" aria-hidden="true" class="header-anchor">#</a> Related playbooks</h2> <ul><li><code>playbooks/backup_swarm.yml</code> is used to back up the swarm data</li> <li><code>playbooks/backup_ucp.yml</code> is used to back up UCP</li> <li><code>playbooks/backup_dtr_meta.yml</code> is used to back up DTR metadata</li> <li><code>playbooks/backup_dtr_images.yml</code> is used to back up DTR images</li></ul></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/gabrielmcg/vp-netlify-test/edit/master/backup-restore/backup-ucp-dtr.md" target="_blank" rel="noopener noreferrer">Help us improve this page!</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/backup-restore/backup-restore.html" class="prev">
          Introduction to backup and restore
        </a></span> <span class="next"><a href="/backup-restore/restore-ucp-dtr.html">
          Restoring your cluster after a disaster
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/24.7648202d.js" defer></script><script src="/assets/js/app.1d742706.js" defer></script>
  </body>
</html>
